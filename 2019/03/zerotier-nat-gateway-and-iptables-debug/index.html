<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  
  <title>Zerotier Nat 网关出口 和 iptables 调试 | Binuxの杂货铺</title>
  <meta name="author" content="Roy Binux">
  
  <meta name="description" content="每当看到各类教程中的 iptables 指令，在格式参数组合之下可以实现从防火墙，封禁 IP 端口到 NAT 的各种操作，就如同魔法一般，看不明白，却又感到无比强大。想学，但又好像不得要领，稍微不慎可能就再也连不上了。最近配置 Zerotier 的 Nat 网关的时候，看着 教程 中的各种指令，抄过">
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Zerotier Nat 网关出口 和 iptables 调试"/>
  <meta property="og:site_name" content="Binuxの杂货铺"/>

  
    <meta property="og:image" content=""/>
  

  <link rel="shortcut icon" href="/favicon.png">
  
    <link rel="alternate" href="/atom.xml" title="Binuxの杂货铺" type="application/atom+xml">
  
  
<link rel="stylesheet" href="/css/style.css">

  <!--[if lt IE 9]><script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script><![endif]-->
  
<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

	ga('create', 'UA-36392342-1', 'auto');
	ga('send', 'pageview');

</script>


<meta name="generator" content="Hexo 6.2.0"></head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">Binuxの杂货铺</a></h1>
  <h2><a href="/"></a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/null">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
      <li><a href="/projects">Projects</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article id="post-zerotier-nat-gateway-and-iptables-debug" class="h-entry post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time class="dt-published" datetime="2019-03-02T06:48:44.000Z"><a href="/2019/03/zerotier-nat-gateway-and-iptables-debug/">2019-03-01</a></time>
      
      
  
    <h1 class="p-name title" itemprop="headline name">Zerotier Nat 网关出口 和 iptables 调试</h1>
  

    </header>
    <div class="e-content entry" itemprop="articleBody">
      
        <p>每当看到各类教程中的 iptables 指令，在格式参数组合之下可以实现从防火墙，封禁 IP 端口到 NAT 的各种操作，就如同魔法一般，看不明白，却又感到无比强大。想学，但又好像不得要领，稍微不慎可能就再也连不上了。最近配置 Zerotier 的 Nat 网关的时候，看着 <a target="_blank" rel="noopener" href="https://zerotier.atlassian.net/wiki/spaces/SD/pages/7110693/Overriding+Default+Route+Full+Tunnel+Mode">教程</a> 中的各种指令，抄过之后完全不通，花了3个晚上之后，逼着搞清楚了怎么 debug ( 打 log ) 后，终于配置成功 (虽然最终失败的原因和 iptables 无关)。</p>
<h2 id="Zerotier"><a href="#Zerotier" class="headerlink" title="Zerotier"></a>Zerotier</h2><p>首先介绍下 <a target="_blank" rel="noopener" href="https://www.zerotier.com/">Zerotier</a> 和为什么要配置 Nat 网关。</p>
<p><a target="_blank" rel="noopener" href="https://www.zerotier.com/">Zerotier</a> 是一个虚拟局域网软件，可以很简单地将无限量（社区服务器版100台）设备放入同一个虚拟局域网中。这样就能在任何网络环境中，访问家中的 NAS 或其他设备。反过来，如果将一台服务器加入这个局域网中，将它配置为一个 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Network_address_translation">NAT</a> 网关，只要你加入这个虚拟局域网，就可以通过它连接世界。</p>
<p>选择 Zerotier 的原因是，它足够简单，只要一个 16 位的 network ID 就能实现组网了，相比我之前用过的 <a target="_blank" rel="noopener" href="https://www.tinc-vpn.org/">tinc</a>，不需要节点 IP，不需要挨个配置节点，并且支持的操作系统广泛。</p>
<p>当然，第一步是<a target="_blank" rel="noopener" href="http://www.zerotier.com/download.shtml">安装 Zerotier</a>，然后<a target="_blank" rel="noopener" href="https://my.zerotier.com/">注册一个帐号</a>，<a target="_blank" rel="noopener" href="https://my.zerotier.com/network">创建一个私人网络</a>。复制 network ID 在本地加入，然后回到网站中通过许可 (<code>Auth?</code>) 就好了。</p>
<p>当你将本地计算机和一台服务器加入网络后，然后就是根据 <a target="_blank" rel="noopener" href="https://zerotier.atlassian.net/wiki/spaces/SD/pages/7110693/Overriding+Default+Route+Full+Tunnel+Mode">这个教程</a> 。运行下面4个命令就行了：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo sysctl -w net.ipv4.ip_forward=1</span><br><span class="line">sudo iptables -t nat -A POSTROUTING -o eth0 -s 10.6.4.0/22 -j SNAT --to-source 45.32.69.220</span><br><span class="line">sudo iptables -A FORWARD -i zt+ -s 10.6.4.0/22 -d 0.0.0.0/0 -j ACCEPT</span><br><span class="line">sudo iptables -A FORWARD -i eth0 -s 0.0.0.0/0 -d 10.6.4.0/0 -j ACCEPT</span><br></pre></td></tr></table></figure>

<p>当然了，很明显，这里的 <code>eth0</code>, <code>10.6.4.0/22</code>, <code>45.32.69.220</code> 是需要根据实际环境替换的，<code>zt+</code> 是指的任何以 <code>zt</code> 开头的网络，zerotier 都是以这样的名字创建的，所以不用修改。这都可以通过 <code>ip addr</code> 或者 <code>ifconfig</code> 进行确认。比如在我的环境中，环境是这样的：</p>
<ul>
<li>网关外网 IP：123.45.67.89</li>
<li>zertier 网络: 192.168.11.0&#x2F;24</li>
<li>网关 zerotier 网络 IP: 192.168.11.1</li>
<li>本机 IP：192.168.11.20</li>
</ul>
<p>命令是这样的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo sysctl -w net.ipv4.ip_forward=1</span><br><span class="line">sudo iptables -t nat -A POSTROUTING -o venet0 -s 192.168.111.0/24 -j SNAT --to-source 123.45.67.89</span><br><span class="line">sudo iptables -A FORWARD -i zt+ -s 192.168.111.0/24 -d 0.0.0.0/0 -j ACCEPT</span><br><span class="line">sudo iptables -A FORWARD -i venet0 -s 0.0.0.0/0 -d 192.168.111.0/24 -j ACCEPT</span><br></pre></td></tr></table></figure>

<p>当我设置完了这些，然后把这个服务器设置为默认 0.0.0.0&#x2F;0 的网关之后，我断网了<br><del>如果这样有用的话，我岂不是就没机会学习 iptables 了。</del>  </p>
<h2 id="iptables"><a href="#iptables" class="headerlink" title="iptables"></a>iptables</h2><p>首先当然是把默认路由改回来。然后，如果只是为了调试，是不需要设置默认路由的，或者说最好不要设置默认路由到这台机器上的，你可以通过</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># macos</span></span><br><span class="line">sudo route add -net 98.76.54.32 192.168.111.1</span><br><span class="line"><span class="comment"># linux</span></span><br><span class="line"><span class="comment"># sudo route add -net 98.76.64.32 gw 192.168.111.1</span></span><br></pre></td></tr></table></figure>

<p>设置一条单独的路由，到另一台主机上，然后就可以单独监控调试这条链路的情况了。</p>
<h3 id="LOG-和-TRACE"><a href="#LOG-和-TRACE" class="headerlink" title="LOG 和 TRACE"></a>LOG 和 TRACE</h3><p>好了，既然现在网络不通，我最想知道的当然是哪断了。</p>
<h4 id="本机-gt-网关"><a href="#本机-gt-网关" class="headerlink" title="本机 -&gt; 网关"></a>本机 -&gt; 网关</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t raw -A PREROUTING -p TCP -s 192.168.111.20 -j LOG</span><br></pre></td></tr></table></figure>

<p>这里就给所有从 本机 发往 网关 的 TCP 数据包打了 LOG，然后 <code>tail -f /var/log/messages</code> （或者 <code>tail -f /var/log/kern.log</code>) 追踪日志。<br>现在你可以从本地往测试服务器发个请求： <code>curl 98.76.54.32</code>，如果在日志中看到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Mar  2 15:53:14 myserver kernel: [5377966.960574] IN=zthnhi321 OUT= MAC=88:55:bb:99:88:88:88:66:11:dd:ff:bb:00:00 SRC=192.168.111.20 DST=98.76.54.32 LEN=64 TOS=0x00 PREC=0x00 TTL=64 ID=45807 DF PROTO=TCP SPT=64408 DPT=80 WINDOW=65535 RES=0x00 SYN URGP=0</span><br></pre></td></tr></table></figure>

<p>那么就可以确认网关确实收到这个包了</p>
<h4 id="网关-gt-网站"><a href="#网关-gt-网站" class="headerlink" title="网关 -&gt; 网站"></a>网关 -&gt; 网站</h4><p>然后可以用 TRACE 追踪这个包是否触发了 NAT。</p>
<blockquote>
<p>在一些环境中，你可能需要开启 TRACE 内核支持，参考 <a target="_blank" rel="noopener" href="https://serverfault.com/questions/385937/how-to-enable-iptables-trace-target-on-debian-squeeze-6">How to Enable IPtables TRACE Target on Debian Squeeze (6)</a></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t raw -A PREROUTING -p TCP -s 192.168.111.20 -j TRACE </span><br></pre></td></tr></table></figure>

<p>你会看到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Mar  2 15:58:11 myserver kernel: [5378263.921579] IN=zthnhi321 OUT= MAC=88:55:bb:99:88:88:88:66:11:dd:ff:bb:00:00 SRC=192.168.111.20 DST=98.76.54.32 LEN=64 TOS=0x00 PREC=0x00 TTL=64 ID=32766 DF PROTO=TCP SPT=65087 DPT=80 WINDOW=65535 RES=0x00 CWR ECE SYN URGP=0</span><br><span class="line">Mar  2 15:58:11 myserver kernel: [5378263.921611] TRACE: raw:PREROUTING:policy:3 IN=zthnhi321 OUT= MAC=88:55:bb:99:88:88:88:66:11:dd:ff:bb:00:00 SRC=192.168.111.20 DST=98.76.54.32 LEN=64 TOS=0x00 PREC=0x00 TTL=64 ID=32766 DF PROTO=TCP SPT=65087 DPT=80 SEQ=3874826404 ACK=0 WINDOW=65535 RES=0x00 CWR ECE SYN URGP=0 OPT (02040ACA2C84454E80103030501000004010800000020000)</span><br><span class="line">Mar  2 15:58:11 myserver kernel: [5378263.921645] TRACE: mangle:PREROUTING:policy:1 IN=zthnhi321 OUT= MAC=88:55:bb:99:88:88:88:66:11:dd:ff:bb:00:00 SRC=192.168.111.20 DST=98.76.54.32 LEN=64 TOS=0x00 PREC=0x00 TTL=64 ID=32766 DF PROTO=TCP SPT=65087 DPT=80 SEQ=3874826404 ACK=0 WINDOW=65535 RES=0x00 CWR ECE SYN URGP=0 OPT (02040ACA2C84454E80103030501000004010800000020000)</span><br><span class="line">Mar  2 15:58:11 myserver kernel: [5378263.921672] TRACE: nat:PREROUTING:policy:1 IN=zthnhi321 OUT= MAC=88:55:bb:99:88:88:88:66:11:dd:ff:bb:00:00 SRC=192.168.111.20 DST=98.76.54.32 LEN=64 TOS=0x00 PREC=0x00 TTL=64 ID=32766 DF PROTO=TCP SPT=65087 DPT=80 SEQ=3874826404 ACK=0 WINDOW=65535 RES=0x00 CWR ECE SYN URGP=0 OPT (02040ACA2C84454E80103030501000004010800000020000)</span><br><span class="line">Mar  2 15:58:11 myserver kernel: [5378263.921698] TRACE: mangle:FORWARD:policy:1 IN=zthnhi321 OUT=venet0 SRC=192.168.111.20 DST=98.76.54.32 LEN=64 TOS=0x00 PREC=0x00 TTL=63 ID=32766 DF PROTO=TCP SPT=65087 DPT=80 SEQ=3874826404 ACK=0 WINDOW=65535 RES=0x00 CWR ECE SYN URGP=0 OPT (02040ACA2C84454E80103030501000004010800000020000)</span><br><span class="line">Mar  2 15:58:11 myserver kernel: [5378263.921719] TRACE: filter:FORWARD:rule:1 IN=zthnhi321 OUT=venet0 SRC=192.168.111.20 DST=98.76.54.32 LEN=64 TOS=0x00 PREC=0x00 TTL=63 ID=32766 DF PROTO=TCP SPT=65087 DPT=80 SEQ=3874826404 ACK=0 WINDOW=65535 RES=0x00 CWR ECE SYN URGP=0 OPT (02040ACA2C84454E80103030501000004010800000020000)</span><br><span class="line">Mar  2 15:58:11 myserver kernel: [5378263.921741] TRACE: mangle:POSTROUTING:policy:1 IN= OUT=venet0 SRC=192.168.111.20 DST=98.76.54.32 LEN=64 TOS=0x00 PREC=0x00 TTL=63 ID=32766 DF PROTO=TCP SPT=65087 DPT=80 SEQ=3874826404 ACK=0 WINDOW=65535 RES=0x00 CWR ECE SYN URGP=0 OPT (02040ACA2C84454E80103030501000004010800000020000)</span><br><span class="line">Mar  2 15:58:11 myserver kernel: [5378263.921763] TRACE: nat:POSTROUTING:rule:1 IN= OUT=venet0 SRC=192.168.111.20 DST=98.76.54.32 LEN=64 TOS=0x00 PREC=0x00 TTL=63 ID=32766 DF PROTO=TCP SPT=65087 DPT=80 SEQ=3874826404 ACK=0 WINDOW=65535 RES=0x00 CWR ECE SYN URGP=0 OPT (02040ACA2C84454E80103030501000004010800000020000)</span><br></pre></td></tr></table></figure>

<p>表明这个包分别经过了</p>
<ul>
<li>raw:PREROUTING:policy:3</li>
<li>mangle:PREROUTING:policy:1</li>
<li>nat:PREROUTING:policy:1</li>
<li>mangle:FORWARD:policy:1</li>
<li>filter:FORWARD:rule:1</li>
<li>mangle:POSTROUTING:policy:1</li>
<li>nat:POSTROUTING:rule:1</li>
</ul>
<p>你可以通过</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -nvL --line-numbers</span><br></pre></td></tr></table></figure>

<p>查看对应的规则编号。在这里，可以看到 <code>filter:FORWARD:rule:1</code> 和 <code>nat:POSTROUTING:rule:1</code> 被触发了。即</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -A FORWARD -i zt+ -s 192.168.111.0/24 -d 0.0.0.0/0 -j ACCEPT</span><br><span class="line">sudo iptables -t nat -A POSTROUTING -o venet0 -s 192.168.111.0/24 -j SNAT --to-source 123.45.67.89</span><br></pre></td></tr></table></figure>

<blockquote>
<p>另外如果你尝试过执行 <code>iptables -t nat -A POSTROUTING -i zt+ -o venet0</code> ，会收到 <code>Can&#39;t use -i with POSTROUTING</code> 报错。从 TRACE 中可以看出 <code>nat:POSTROUTING:rule:1</code> 中 <code>IN=</code> 是空的。所以在 <code>POSTROUTING</code> 表中是不能使用 <code>-i</code> 指定入包接口的。</p>
</blockquote>
<h4 id="网站-gt-网关-gt-本机"><a href="#网站-gt-网关-gt-本机" class="headerlink" title="网站 -&gt; 网关 -&gt; 本机"></a>网站 -&gt; 网关 -&gt; 本机</h4><p>这次我们一步到位</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -t raw -A PREROUTING -p TCP -s 98.76.54.32 -j LOG</span><br><span class="line">iptables -t raw -A PREROUTING -p TCP -s 98.76.54.32 -j TRACE</span><br></pre></td></tr></table></figure>

<p>另外为了防止日志太多，这里可以把刚才添加的那条 TRACE 删掉：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t raw -D PREROUTING -p TCP -s 192.168.111.20 -j TRACE </span><br></pre></td></tr></table></figure>

<p>再次 <code>curl 98.76.54.32</code> 就能看到包返回了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Mar  3 14:04:55 myserver kernel: [5457820.771146] IN=zthnhi321 OUT= MAC=88:55:bb:99:88:88:88:66:11:dd:ff:bb:00:00 SRC=192.168.111.20 DST=98.76.54.32 LEN=64 TOS=0x00 PREC=0x00 TTL=64 ID=64965 DF PROTO=TCP SPT=57286 DPT=80 WINDOW=65535 RES=0x00 CWR ECE SYN URGP=0</span><br><span class="line">Mar  3 14:04:55 myserver kernel: [5457820.771696] IN=venet0 OUT= MAC= SRC=98.76.54.32 DST=123.45.67.89 LEN=60 TOS=0x00 PREC=0x00 TTL=55 ID=0 DF PROTO=TCP SPT=80 DPT=57286 WINDOW=14480 RES=0x00 ECE ACK SYN URGP=0</span><br><span class="line">Mar  3 14:04:55 myserver kernel: [5457820.771713] TRACE: raw:PREROUTING:policy:4 IN=venet0 OUT= MAC= SRC=98.76.54.32 DST=123.45.67.89 LEN=60 TOS=0x00 PREC=0x00 TTL=55 ID=0 DF PROTO=TCP SPT=80 DPT=57286 SEQ=1319922288 ACK=3993987234 WINDOW=14480 RES=0x00 ECE ACK SYN URGP=0 OPT (020401AA7250238401080A2F75F14B4048030307)</span><br><span class="line">Mar  3 14:04:55 myserver kernel: [5457820.771729] TRACE: mangle:PREROUTING:policy:1 IN=venet0 OUT= MAC= SRC=98.76.54.32 DST=123.45.67.89 LEN=60 TOS=0x00 PREC=0x00 TTL=55 ID=0 DF PROTO=TCP SPT=80 DPT=57286 SEQ=1319922288 ACK=3993987234 WINDOW=14480 RES=0x00 ECE ACK SYN URGP=0 OPT (020401AA7250238401080A2F75F14B4048030307)</span><br><span class="line">Mar  3 14:04:55 myserver kernel: [5457820.771743] TRACE: mangle:FORWARD:policy:1 IN=venet0 OUT=zthnhi321 SRC=98.76.54.32 DST=192.168.111.20 LEN=60 TOS=0x00 PREC=0x00 TTL=55 ID=0 DF PROTO=TCP SPT=80 DPT=57286 SEQ=1319922288 ACK=3993987234 WINDOW=14480 RES=0x00 ECE ACK SYN URGP=0 OPT (020401AA7250238401080A2F75F14B4048030307)</span><br><span class="line">Mar  3 14:04:55 myserver kernel: [5457820.771755] TRACE: filter:FORWARD:rule:2 IN=venet0 OUT=zthnhi321 SRC=98.76.54.32 DST=192.168.111.20 LEN=60 TOS=0x00 PREC=0x00 TTL=55 ID=0 DF PROTO=TCP SPT=80 DPT=57286 SEQ=1319922288 ACK=3993987234 WINDOW=14480 RES=0x00 ECE ACK SYN URGP=0 OPT (020401AA7250238401080A2F75F14B4048030307)</span><br><span class="line">Mar  3 14:04:55 myserver kernel: [5457820.771767] TRACE: mangle:POSTROUTING:policy:1 IN= OUT=zthnhi321 SRC=98.76.54.32 DST=192.168.111.20 LEN=60 TOS=0x00 PREC=0x00 TTL=55 ID=0 DF PROTO=TCP SPT=80 DPT=57286 SEQ=1319922288 ACK=3993987234 WINDOW=14480 RES=0x00 ECE ACK SYN URGP=0 OPT (020401AA7250238401080A2F75F14B4048030307)</span><br></pre></td></tr></table></figure>

<p>同理，可以看到数据包在经过 <code>mangle:PREROUTING:policy:1</code> 之后，DST 被改写回了 <code>192.168.111.20</code>。于是一次成功的 NAT 就完成了。</p>
<p>最后，这里有一张图，显示了数据包都会经过什么表:</p>
<p><a title="Jan Engelhardt [CC BY-SA 3.0 (https://creativecommons.org/licenses/by-sa/3.0)], via Wikimedia Commons" target="_blank" rel="noopener" href="https://commons.wikimedia.org/wiki/File:Netfilter-packet-flow.svg"><img width="512" alt="Netfilter-packet-flow" src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/37/Netfilter-packet-flow.svg/512px-Netfilter-packet-flow.svg.png"></a></p>
<blockquote>
<p>之前配置 NAT 网关不成功的原因是：zerotier 防火墙错误设置了如下规则，导致包没法发回本机。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">drop</span><br><span class="line">	not chr ipauth</span><br><span class="line">;</span><br></pre></td></tr></table></figure>


<h2 id="网关"><a href="#网关" class="headerlink" title="网关+"></a>网关+</h2><p>既然有网关了，我就想能不能再搞个智能回国网关。，只要我连上这个局域网，就能听网易云音乐了。我用的 vnet.one 用的是 anyconnect 连接，它有一个开源实现 openconnect，于是我<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/38369950/openconnect-not-able-to-connect-to-gateway/42342253">这样</a>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install curl vpnc-scripts build-essential libssl-dev libxml2-dev liblz4-dev</span><br><span class="line">wget ftp://ftp.infradead.org/pub/openconnect/openconnect-8.02.tar.gz</span><br><span class="line">tar xzf openconnect-8.02.tar.gz</span><br><span class="line"><span class="built_in">cd</span> openconnect-8.02</span><br><span class="line">./configure --without-gnutls --with-vpnc-script=/usr/share/vpnc-scripts/vpnc-script</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br><span class="line">sudo ldconfig /usr/local/lib</span><br></pre></td></tr></table></figure>

<p>然后用 <a target="_blank" rel="noopener" href="https://github.com/ashi009/bestroutetb">bestroutetb</a> 生成个路由：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bestroutetb --route.net=US,GB  --route.vpn=CN -p json -o routes.json -f</span><br><span class="line">jq <span class="string">&#x27;.[] | select(.gateway == &quot;vpn&quot;) | .prefix + &quot;/&quot; + (.length | tostring)&#x27;</span>  routes.json  -c -r &gt; routes.cn</span><br></pre></td></tr></table></figure>

<p>整个设置路由的脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">source</span> /root/.bashrc</span><br><span class="line"></span><br><span class="line">DIR=$(<span class="built_in">dirname</span> <span class="variable">$0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Routes that we want to be used by the VPN link</span></span><br><span class="line">ROUTES=`<span class="built_in">cat</span> <span class="variable">$DIR</span>/routes.cn`</span><br><span class="line"></span><br><span class="line"><span class="comment"># Helpers to create dotted-quad netmask strings.</span></span><br><span class="line">MASKS[1]=<span class="string">&quot;128.0.0.0&quot;</span></span><br><span class="line">MASKS[2]=<span class="string">&quot;192.0.0.0&quot;</span></span><br><span class="line">MASKS[3]=<span class="string">&quot;224.0.0.0&quot;</span></span><br><span class="line">MASKS[4]=<span class="string">&quot;240.0.0.0&quot;</span></span><br><span class="line">MASKS[5]=<span class="string">&quot;248.0.0.0&quot;</span></span><br><span class="line">MASKS[6]=<span class="string">&quot;252.0.0.0&quot;</span></span><br><span class="line">MASKS[7]=<span class="string">&quot;254.0.0.0&quot;</span></span><br><span class="line">MASKS[8]=<span class="string">&quot;255.0.0.0&quot;</span></span><br><span class="line">MASKS[9]=<span class="string">&quot;255.128.0.0&quot;</span></span><br><span class="line">MASKS[10]=<span class="string">&quot;255.192.0.0&quot;</span></span><br><span class="line">MASKS[11]=<span class="string">&quot;255.224.0.0&quot;</span></span><br><span class="line">MASKS[12]=<span class="string">&quot;255.240.0.0&quot;</span></span><br><span class="line">MASKS[13]=<span class="string">&quot;255.248.0.0&quot;</span></span><br><span class="line">MASKS[14]=<span class="string">&quot;255.252.0.0&quot;</span></span><br><span class="line">MASKS[15]=<span class="string">&quot;255.254.0.0&quot;</span></span><br><span class="line">MASKS[16]=<span class="string">&quot;255.255.0.0&quot;</span></span><br><span class="line">MASKS[17]=<span class="string">&quot;255.255.128.0&quot;</span></span><br><span class="line">MASKS[18]=<span class="string">&quot;255.255.192.0&quot;</span></span><br><span class="line">MASKS[19]=<span class="string">&quot;255.255.224.0&quot;</span></span><br><span class="line">MASKS[20]=<span class="string">&quot;255.255.240.0&quot;</span></span><br><span class="line">MASKS[21]=<span class="string">&quot;255.255.248.0&quot;</span></span><br><span class="line">MASKS[22]=<span class="string">&quot;255.255.252.0&quot;</span></span><br><span class="line">MASKS[23]=<span class="string">&quot;255.255.254.0&quot;</span></span><br><span class="line">MASKS[24]=<span class="string">&quot;255.255.255.0&quot;</span></span><br><span class="line">MASKS[25]=<span class="string">&quot;255.255.255.128&quot;</span></span><br><span class="line">MASKS[26]=<span class="string">&quot;255.255.255.192&quot;</span></span><br><span class="line">MASKS[27]=<span class="string">&quot;255.255.255.224&quot;</span></span><br><span class="line">MASKS[28]=<span class="string">&quot;255.255.255.240&quot;</span></span><br><span class="line">MASKS[29]=<span class="string">&quot;255.255.255.248&quot;</span></span><br><span class="line">MASKS[30]=<span class="string">&quot;255.255.255.252&quot;</span></span><br><span class="line">MASKS[31]=<span class="string">&quot;255.255.255.254&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> CISCO_SPLIT_INC=0</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create environment variables that vpnc-script uses to configure network</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">addroute</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">local</span> ROUTE=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line">    <span class="built_in">export</span> CISCO_SPLIT_INC_<span class="variable">$&#123;CISCO_SPLIT_INC&#125;</span>_ADDR=<span class="variable">$&#123;ROUTE%%/*&#125;</span></span><br><span class="line">    <span class="built_in">export</span> CISCO_SPLIT_INC_<span class="variable">$&#123;CISCO_SPLIT_INC&#125;</span>_MASKLEN=<span class="variable">$&#123;ROUTE##*/&#125;</span></span><br><span class="line">    <span class="built_in">export</span> CISCO_SPLIT_INC_<span class="variable">$&#123;CISCO_SPLIT_INC&#125;</span>_MASK=<span class="variable">$&#123;MASKS[<span class="variable">$&#123;ROUTE##*/&#125;</span>]&#125;</span></span><br><span class="line">    <span class="built_in">export</span> CISCO_SPLIT_INC=$((<span class="variable">$&#123;CISCO_SPLIT_INC&#125;</span>+<span class="number">1</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> r <span class="keyword">in</span> <span class="variable">$ROUTES</span>; <span class="keyword">do</span></span><br><span class="line">    addroute <span class="variable">$r</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> l <span class="keyword">in</span> <span class="variable">$INTERNAL_IP4_DNS</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$reason</span> = <span class="string">&quot;connect&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        iptables -t nat -A PREROUTING -i zt+ -p udp --dport 53 -j DNAT --to <span class="variable">$l</span></span><br><span class="line">    <span class="keyword">elif</span> [ <span class="variable">$reason</span> = <span class="string">&quot;disconnect&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        iptables -t nat -D PREROUTING -i zt+ -p udp --dport 53 -j DNAT --to <span class="variable">$l</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">break</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exec</span> /usr/share/vpnc-scripts/vpnc-script</span><br></pre></td></tr></table></figure>

<p>整合一下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;password&quot;</span> | openconnect address.example.org -u username --passwd-on-stdin --non-inter --script /root/openconnect/script.sh</span><br></pre></td></tr></table></figure>

<p>完成。只不过，如果要看 bilibili 还需要设置 DNS 到国内，或者设置到网关上（上面的脚本配置了 DNS 转发）。而且 zerotier 只是为了虚拟局域网设计的，不如 anyconnect 能自动设置网关，路由，DNS方便。不过挺好玩的，还学了不少东西，over。</p>

      
    </div>
    <footer>
      
        
        
  
  <div class="tags">
    <a href="/tags/zerotier/">zerotier</a>, <a href="/tags/nat-gateway/">nat gateway</a>, <a href="/tags/full-tunnel-mode/">full tunnel mode</a>, <a href="/tags/iptables/">iptables</a>
  </div>

        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
  <h1 class="title">留言</h1>

  
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
  
</section>

</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="as_sitesearch" value="binux.blog">
  </form>
</div>


  <div class="widget tag about_me">
  <h3 class="title">About Me</h3>
  <ul class="entry">
    
    <li>
      <span class="icon email"></span>
      <a href="mailto:roy@binux.me" target=_blank rel=me>roy@binux.me</a>
    </li>
    

    
    <li>
      <span class="icon github"></span>
      <a href="https://github.com/binux" target=_blank rel=me>github.com/binux</a>
    </li>
    

    
    <li>
      <span class="icon twitter"></span>
      <a href="https://twitter.com/roybinux" target=_blank rel=me>@roybinux</a>
    </li>
    

    
    <li>
      <span class="icon gplus"></span>
      <a href="https://plus.google.com/+RoyBinux" target=_blank rel=me>+RoyBinux</a>
    </li>
    
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">最新文章</h3>
  <ul class="entry">
    
      <li>
        <a href="/2020/01/home-assistant/">家居自动化</a>
      </li>
    
      <li>
        <a href="/2019/03/zerotier-nat-gateway-and-iptables-debug/">Zerotier Nat 网关出口 和 iptables 调试</a>
      </li>
    
      <li>
        <a href="/2018/10/girls-frontline-ankulua-vision/">少女前线拖尸脚本 和 生成它的可视化工具</a>
      </li>
    
      <li>
        <a href="/2018/02/us/">2018 新的冒险</a>
      </li>
    
      <li>
        <a href="/2016/12/data-highlighter/">Data Highlighter</a>
      </li>
    
  </ul>
</div>


  <div class="widget tag recent-comments">
  <h3 class="title">近期评论</h3>
  <div class="entry">
    <script type="text/javascript" src="//binux.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=0&amp;avatar_size=32&amp;excerpt_length=50"></script>
  </div>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2022 Roy Binux
  
</div>
<div class="clearfix"></div></footer>
  
<script src="/js/jquery-3.4.1.min.js"></script>


<script src="/js/jquery.imagesloaded.min.js"></script>


<script src="/js/gallery.js"></script>



<script>
var disqus_shortname = 'binux';
var disqus_config = function () {
this.page.url = 'https://binux.blog/2019/03/zerotier-nat-gateway-and-iptables-debug/';
this.page.identifier = 'https://binux.blog/2019/03/zerotier-nat-gateway-and-iptables-debug/';
};

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script src="/fancybox/jquery.fancybox.pack.js"></script>

<script>
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


</body>
</html>
